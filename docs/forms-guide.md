# BifrostQL Forms - User Guide

BifrostQL Forms generates HTML forms directly from your database schema. Forms work without JavaScript using standard `<form>` POST submission, with optional progressive enhancement.

## Getting Started

### 1. Create a Form Builder

```csharp
using BifrostQL.Core.Forms;
using BifrostQL.Core.Model;

// dbModel is your loaded IDbModel instance
var formBuilder = new BifrostFormBuilder(dbModel);
```

### 2. Generate a Form

```csharp
// Insert form - new record
string insertHtml = formBuilder.GenerateForm("Users", FormMode.Insert);

// Update form - edit existing record
var values = new Dictionary<string, string?>
{
    ["Id"] = "42",
    ["Name"] = "Alice",
    ["Email"] = "alice@example.com"
};
string updateHtml = formBuilder.GenerateForm("Users", FormMode.Update, values);

// Delete form - confirmation
string deleteHtml = formBuilder.GenerateForm("Users", FormMode.Delete, values);
```

### 3. Include the Optional Stylesheet

Add the default stylesheet to your HTML head:

```html
<link rel="stylesheet" href="/wwwroot/bifrost-forms.css">
```

Or skip it entirely and use your own styles. The generated HTML uses semantic classes (`form-group`, `form-actions`, `btn-primary`, etc.) that you can target.

## Form Modes

### Insert Mode

Generates a form for creating new records.

- IDENTITY columns are excluded (auto-generated by the database)
- Columns with `populate` metadata (audit fields) are excluded
- NOT NULL columns get `required` and `aria-required="true"` attributes
- Default values are applied when available

The form POSTs to `/bifrost/form/{table}/insert`.

### Update Mode

Generates a form for editing an existing record.

- Primary key columns render as hidden fields
- All editable fields are pre-populated with current values
- The form POSTs to `/bifrost/form/{table}/update/{id}`

Pass the current row values as a `Dictionary<string, string?>`:

```csharp
var values = new Dictionary<string, string?>
{
    ["Id"] = "42",
    ["Name"] = "Current Name",
    ["Email"] = "current@email.com"
};
var html = formBuilder.GenerateForm("Users", FormMode.Update, values);
```

### Delete Mode

Generates a confirmation form with a read-only record summary.

- Primary key is a hidden field
- All columns are displayed as a definition list (read-only)
- A confirmation prompt asks the user to verify
- The submit button sends `confirm=yes`
- The form POSTs to `/bifrost/form/{table}/delete/{id}`

## Type Mapping

BifrostQL automatically maps database column types to HTML5 input types:

| Database Type | HTML Element | Attributes |
|---|---|---|
| `int`, `bigint`, `smallint`, `tinyint` | `<input type="number">` | `step="1"` |
| `decimal`, `numeric`, `money` | `<input type="number">` | `step="0.01"` |
| `float`, `real` | `<input type="number">` | `step="any"` |
| `varchar`, `nvarchar`, `char` | `<input type="text">` | |
| `text`, `ntext` | `<textarea>` | `rows="5"` |
| `bit`, `boolean` | `<input type="checkbox">` | |
| `date` | `<input type="date">` | |
| `datetime`, `datetime2` | `<input type="datetime-local">` | |
| `time` | `<input type="time">` | |
| `uniqueidentifier` | `<input type="text">` | UUID pattern |
| `varbinary`, `image` | `<input type="file">` | `accept="image/*"` |

## Foreign Key Handling

When a column has a foreign key relationship, BifrostQL renders a `<select>` dropdown instead of a text input.

### Providing Options

Pass foreign key options when generating the form:

```csharp
var fkOptions = new Dictionary<string, IReadOnlyList<(string value, string displayText)>>
{
    ["DepartmentId"] = new List<(string, string)>
    {
        ("1", "Engineering"),
        ("2", "Sales"),
        ("3", "Marketing")
    }
};

var html = formBuilder.GenerateForm("Employees", FormMode.Insert, foreignKeyOptions: fkOptions);
```

### Display Column Detection

Use `ForeignKeyHandler.GetDisplayColumn(referencedTable)` to determine the best display column from a referenced table. The priority order is:

1. Columns named `name`, `title`, or `description`
2. First `varchar`/`nvarchar` column that is not a primary key
3. Primary key column

## File Uploads

Binary columns (`varbinary`, `binary`, `image`, `blob`) render as file inputs.

- The form automatically adds `enctype="multipart/form-data"` when binary columns are present
- In update mode with an existing value, help text shows "Leave empty to keep current file"
- Custom accept types can be set via metadata configuration

## Enum Controls

Configure columns as enums to render radio buttons or select dropdowns:

```csharp
var metadata = new FormsMetadataConfiguration()
    .ConfigureColumn("Users", "Status", col =>
    {
        col.EnumValues = new[] { "active", "inactive", "pending" };
        col.EnumDisplayNames = new Dictionary<string, string>
        {
            ["active"] = "Active",
            ["inactive"] = "Inactive",
            ["pending"] = "Pending Approval"
        };
    });

var formBuilder = new BifrostFormBuilder(dbModel, metadataConfiguration: metadata);
```

- 4 or fewer options: radio buttons inside a `<fieldset>`
- 5 or more options: `<select>` dropdown

## Metadata Configuration

Customize form control behavior per column:

```csharp
var metadata = new FormsMetadataConfiguration();

// Override input type
metadata.ConfigureColumn("Users", "Email", col => col.InputType = "email");

// Add placeholder
metadata.ConfigureColumn("Users", "Email", col => col.Placeholder = "user@example.com");

// Add pattern validation
metadata.ConfigureColumn("Users", "Phone", col => col.Pattern = "[0-9]{3}-[0-9]{3}-[0-9]{4}");

// Set numeric range
metadata.ConfigureColumn("Products", "Price", col =>
{
    col.Min = 0;
    col.Max = 999999.99;
    col.Step = 0.01;
});

// Custom file accept types
metadata.ConfigureColumn("Products", "Document", col => col.Accept = "application/pdf,.doc");
```

### Available Metadata Properties

| Property | Type | Purpose |
|---|---|---|
| `InputType` | `string?` | Override HTML input type (`email`, `tel`, `url`) |
| `Placeholder` | `string?` | Placeholder text for the input |
| `Pattern` | `string?` | HTML5 pattern attribute for regex validation |
| `Min` | `double?` | Minimum value for numeric inputs |
| `Max` | `double?` | Maximum value for numeric inputs |
| `Step` | `double?` | Step value for numeric inputs |
| `EnumValues` | `string[]?` | Enum option values (renders radio/select) |
| `EnumDisplayNames` | `IReadOnlyDictionary<string, string>?` | Display labels for enum values |
| `Accept` | `string?` | Accept attribute for file inputs |

## Validation

### Server-Side Validation

`BifrostFormValidator` validates form data against the database schema:

```csharp
var validator = new BifrostFormValidator();
var result = validator.Validate(formValues, table, FormMode.Insert);

if (!result.IsValid)
{
    // Re-render form with errors
    var html = formBuilder.GenerateForm("Users", FormMode.Insert,
        values: formValues, errors: result.Errors);
}
```

Validation checks:
- **Required**: NOT NULL columns without `populate` metadata must have values
- **Type**: Numeric, boolean, and date/time values are type-checked
- **IDENTITY columns**: Skipped (auto-generated)
- **Delete mode**: Only primary key is validated

### Error Display

When errors are passed to `GenerateForm`, the affected fields show:
- `class="form-group error"` on the containing div
- `aria-invalid="true"` on the input element
- `aria-describedby` linking to the error message
- `<span class="error-message">` with the error text

## View Pages

### Detail View

`DetailViewBuilder` generates read-only detail pages:

```csharp
var detailBuilder = new DetailViewBuilder(dbModel);
var recordData = new Dictionary<string, object?>
{
    ["Id"] = 42,
    ["Name"] = "Alice",
    ["Email"] = "alice@example.com",
    ["CreatedAt"] = new DateTime(2024, 1, 15)
};
string html = detailBuilder.GenerateDetailView("Users", recordData);
```

Features:
- Definition list layout
- Type-appropriate formatting (dates as `<time>`, booleans as Yes/No)
- Foreign key columns link to the related record's detail page
- Email and URL columns render as clickable links
- Edit, Delete, and Back to List action links

### List View

`ListViewBuilder` generates table-based list pages with sorting and pagination:

```csharp
var listBuilder = new ListViewBuilder(dbModel);
var pagination = new PaginationInfo(currentPage: 1, pageSize: 25, totalRecords: 100);
var records = new List<IReadOnlyDictionary<string, object?>> { /* row data */ };

string html = listBuilder.GenerateListView("Users", records, pagination,
    currentSort: "Name", currentDir: "asc", currentSearch: "alice");
```

Features:
- Sortable column headers (click to toggle asc/desc)
- Pagination navigation (First, Previous, Next, Last)
- Search form with query preservation
- Maximum column limit (default 7) for readability
- First text column links to the detail view
- Long text truncated to 100 characters
- View, Edit, Delete action links per row

## Progressive Enhancement

Include the optional JavaScript file for client-side enhancements:

```html
<script src="/wwwroot/bifrost-forms-enhance.js" defer></script>
```

### Client-Side Validation

The script adds HTML5 Constraint Validation API support. Forms validate on submit and show error messages without a server round-trip. If JavaScript is disabled, validation falls back to the server.

### Delete Confirmation

Delete buttons get a `window.confirm()` dialog as an extra safety layer.

### File Upload Preview

Image file inputs show a preview thumbnail after file selection.

### AJAX Submission

Add `data-ajax` to a form to enable AJAX submission:

```html
<form class="bifrost-form" data-ajax method="POST" action="/bifrost/form/users/insert">
```

The server detects AJAX requests via the `X-Requested-With: XMLHttpRequest` header and returns JSON. On failure, the script falls back to a standard form submission.

## Custom Base Path

Change the URL prefix used in form actions and view links:

```csharp
var formBuilder = new BifrostFormBuilder(dbModel, basePath: "/admin/db");
var detailBuilder = new DetailViewBuilder(dbModel, basePath: "/admin/db");
var listBuilder = new ListViewBuilder(dbModel, basePath: "/admin/db");
```

This changes actions from `/bifrost/form/...` to `/admin/db/form/...`.

## CSS Theming

The default stylesheet uses CSS custom properties. Override them to match your brand:

```css
:root {
  --bf-primary: #2563eb;
  --bf-danger: #ef4444;
  --bf-focus: #1d4ed8;
  --bf-radius: 8px;
  --bf-font: "Inter", sans-serif;
}
```

## Security

- All generated HTML is XSS-safe: values are HTML-encoded via `WebUtility.HtmlEncode`
- Form actions use parameterized queries (via BifrostQL's SQL generation)
- File uploads should be validated server-side for size and content type
- Use SameSite cookies and same-origin policy for CSRF protection
